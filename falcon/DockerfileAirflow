# Dockerfile zum Bauen eines Falcon-Images
FROM python:3.8

WORKDIR /app

RUN apt-get update && apt-get install -y wget unzip && rm -rf /var/lib/apt/lists/*

RUN python3 -m venv /app/.venv
ENV PATH="/app/.venv/bin:$PATH"

RUN git clone https://github.com/SDM-TIB/falcon2.0.git /app/falcon2.0
WORKDIR /app/falcon2.0
RUN pip install -r requirements.txt && python3 -m spacy download en_core_web_sm

ENV ES_HOST=http://localhost:9200

RUN find /app/falcon2.0 -type f -name "*.py" -exec sed -i "s|Elasticsearch(\['http://node1.research.tib.eu:9200/'\])|Elasticsearch(['http://localhost:9200/'])|g" {} +
RUN find /app/falcon2.0 -type f -exec sed -i \
    -e 's|http://node1.research.tib.eu:4001/sparql|https://dbpedia.org/sparql/|g' \
    -e 's|http://node3.research.tib.eu:4010/sparql|https://query.wikidata.org/|g' {} +
RUN find /app/falcon2.0 -type f -name "*.py" -exec sed -i -E \
    "s/(es\.search\(.*)doc_type=[^,)]*,?\s*(.*\))/\1\2/g" {} +
RUN find /app/falcon2.0 -type f -name "*.py" -exec sed -i -E \
    "s/(es\.index\(.*)doc_type=[^,)]*,?\s*(.*\))/\1\2/g" {} +
RUN sed -i \
    -e 's/doc_type=docType, //g' /app/falcon2.0/Elastic/searchIndex.py
RUN sed -i \
    -e '/^    except:/d' \
    -e '/^    #raise/d' \
    -e '/^    print("error")/d' \
    -e '/^    try:$/d' /app/falcon2.0/main.py

WORKDIR /app
RUN wget -P /app https://figshare.com/ndownloader/files/20168714 -O /app/wikidata_dump.zip \
    && unzip -o /app/wikidata_dump.zip -d /app \
    && rm /app/wikidata_dump.zip
RUN .venv/bin/activate && elasticdump --output=$ES_HOST/wikidataentityindex/ --input=/app/wikidataentity.json --type=data --limit=5000
RUN .venv/bin/activate && elasticdump --output=$ES_HOST/wikidatapropertyindex/ --input=/app/wikidatapropertyindex.json --type=data --limit=5000